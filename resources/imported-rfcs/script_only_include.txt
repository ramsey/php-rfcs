====== PHP RFC: Introduce script only include/require ======
  * Version: 0.3
  * Date: 2015-02-10
  * Author: Yasuo Ohgaki <yohgaki@ohgaki.net>
  * Status: Under Discussion
  * First Published at: http://wiki.php.net/rfc/script_and_script_once
  * Renamed to: http://wiki.php.net/rfc/script_path
  * Renamed to: http://wiki.php.net/rfc/script_only_include

===== Introduction =====
include()/require() is source of file/script inclusion for a long time. **File inclusion is extremely severe security breach** and **PHP is too weak against file inclusion attacks.** 

====Solution====
Solution for this issue is simple. Introduce **script only include/require** and modify **move_uploaded_file()**  function not to move PHP script embedded files. With this RFC, PHP becomes as secure as other languages against file inclusion attacks.

====In the wild attacks/vulnerabilities====

File inclusion attacks are too common in PHP, not like other languages.

http://www.exploit-db.com/search/?action=search&filter_page=1&filter_description=PHP&filter_exploit_text=inclusion&filter_author=&filter_platform=0&filter_type=0&filter_lang_id=0&filter_port=&filter_osvdb=&filter_cve=

====OS protection is **NOT** perfect protection====

OS protection works well for system file. However, any applications support file uploads can be attacked by inclusion attacks. i.e. require('../../upload/evil_file') can be done with bad PHP code.

====open_basedir is not helpful====

open_basedir restrict file reads, but it's not helpful. Attackers use uploaded files to exploit PHP applications. These uploaded files are images, document, etc. Session data file is common target for attackers also.

====Uploaded Files====

Users are supposed to use move_uploaded_file() function to move uploaded files to destination directory. move_uploaded_files() is modified to detect PHP code and refuse to move it. 

===== Proposal =====

Introduce **script_embed** INI (Default: script_embed=Off) that specify script embedding in a script file is allowed. Modify **move_upload_file()** to detect and to refuse script embedded files with when script_embed=On.

include()/include_once()/require()/require_once()/move_uploaded_file() are affected by **script_embed** INI.

**Current:**

Allows embedded PHP script always.
<code php>
require('/path/to/docroot/upload/file'); // Read any file if it contains PHP code, execute.
require('/etc/passwd'); // Read any file if it contains PHP code, execute.

move_uploaded_file($source, $destination); // Success if it has PHP code
</code>

**New:**

script_embed=Off
<code php>
require('/path/to/php_script'); // Read & execute 
require('/path/to/other_file'); // E_RECOVERBLE_ERROR - Not a PHP script
include('/etc/passwd'); // E_RECOVERBLE_ERROR - Not a PHP script

move_uploaded_file($source, $destination); // Fails if it has PHP code
</code>

move_uploaded_file() searches "start tag" token if it is located as the first token.

==== Pros and Cons ====

When script_embed=On, nothing changes.

When script_embed=Off,

Pros
  * Only PHP script files are executed as PHP script. (Files usually started with <?php, but it's not limited)
  * move_uploaded_file() prevents uploading PHP scripts.
  * Attacker tries to exploit LFI, cannot read and execute if file is not a PHP script.

Cons
  * move_uploaded_file() cannot be used for PHP script uploading. (User must use compression/encryption for PHP scripts)
  * Attacker may have access to any accessible PHP script. (Use open_basedir, OS protection)



===== Backward Incompatible Changes =====

No BC when script_embed=On.

move_uploaded_file() cannot move PHP script when script_embed=Off.

===== Proposed PHP Version(s) =====

PHP 7

===== RFC Impact =====
==== To SAPIs ====

None

==== To Existing Extensions ====

None including extensions that have custom script loader.

==== To Opcache ====

None

==== New Constants ====

None

==== php.ini Defaults ====

script_embed=On/Off (INI_ALL, Default: Off for all)

  * hardcoded default values
  * php.ini-development values
  * php.ini-production values

===== Open Issues =====


===== Unaffected PHP Functionality =====

require/include/move_uploaded_file remains the same when it is not enabled.

===== Future Scope =====

  * Removal of "script_embed" INI switch. Perhaps, require($file, $embed_flag)?
  * Allow script execution only for index.php (Entry point)
  * Allow script without PHP tag.

===== Proposed Voting Choices =====

State whether this project requires a 2/3 or 50%+1 majority (see [[voting]])

50%+1 vote?

===== Patches and Tests =====


===== Implementation =====

  - the version(s) it was merged to
  - a link to the git commit(s)
  - a link to the PHP manual entry for the feature

===== References =====

  * https://wiki.php.net/rfc/nophptags


===== Rejected Features =====
Keep this updated with features that were discussed on the mail lists.
