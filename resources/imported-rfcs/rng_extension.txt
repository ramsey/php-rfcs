====== PHP RFC: Add Randomizer class ======
  * Version: 0.2
  * Date: 2021-05-18
  * Author: Go Kudo <zeriyoshi@gmail.com>
  * Status: Draft
  * First Published at: http://wiki.php.net/rfc/object_scope_prng

===== Introduction =====
PHP is currently having problems with RNG reproducibility.

PHP's RNG has been unified into an implementation using the Mersenne twister, with the rand() and srand() functions becoming aliases for mt_rand() and mt_srand() respectively in PHP 7.1.

But, these functions still store the state in the global state of PHP and are not easily reproducible. Look at the following example.

<code php>
echo foo(1234, function (): void {}) . PHP_EOL; // Result: 1480009472
echo foo(1234, function (): void { mt_rand(); }) . PHP_EOL; // Result: 1747253290

function foo(int $seed, callable $bar): int {
    mt_srand($seed);
    $result = mt_rand();
    $bar();
    $result += mt_rand();
    return $result;
}
</code>

As mentioned above, the reproducibility of random numbers can easily be lost if additional processing is added later.

In addition, the fiber extension was introduced in PHP 8.1. This makes it more difficult to keep track of the execution order. However, this problem has existed since the inception of Generator.

There is also the problem of functions that implicitly use the state stored in PHP's global state. shuffle(), str_shuffle(), and array_rand() functions implicitly advance the state of a random number. This means that the following code is not reproducible, but it is difficult for the user to notice this.

<code php>
mt_srand(1234);
echo mt_rand() . PHP_EOL; // Result: 411284887

mt_srand(1234);
str_shuffle('foobar');
echo mt_rand() . PHP_EOL; // Result: 1314500282
</code>

===== Proposal =====
Implements Randomizer class.

This class implement to ext/standard, always bundled PHP core.

The PHP code that represents the implementation is as follows:

<code php>
const RANDOMIZER_XORSHIFT128PLUS = 'xorshift128+'; // fast, lightweight, default
const RANDOMIZER_MT19937 = 'mt19937 '; // for compatibility
const RANDOMIZER_SECURE = 'secure'; // required Cryptographically-Secure PRNG
const RANDOMIZER_USER = 'user'; // userland implementation

class Randomizer
{
    public function __construct(string $algo = RANDOMIZER_XORSHIFT128PLUS, ?int $seed = null);

    // For user.
    public function int(?int $min = PHP_INT_MIN, ?int $max = PHP_INT_MAX): int;
    public function bytes(int $length): string;
    public function shuffle(array|string $target): array|string;

    // For serialize / unserialize. (but, NOT always available.)
    public function __serialize(): array;
    public function __unserialize(array $data): void;

    // MUST override in RANDOMIZER_USER.
    protected function next(): int;
}
</code>

This single class is used to provide the processing using PRNG.

This class switches the PRNG implementation to be used by the constructor argument $algo. It is just like the password_hash() function.

Similarly, several C APIs have been added to the PHP core. This can be used to add non-standard PRNGs.

<code c>
typedef struct _php_randomizer_algo {
    const char *ident;
    void (*seed)(const zend_long *seed);
    uint64_t (*next)(void);
    int (*serialize)(zval *data); // allows NULL.
    int (*unserialize)(zval *data); // allows NULL.
} php_randomizer_algo;

int php_randomizer_algo_register(const char *ident, const php_rng_algo *algo);
void php_randomizer_algo_unregister(const char *ident);
</code>

In php_randomizer_algo, the implementation of serialize / unserialize is optional. If the RNG you implement does not support it, you can specify NULL as a member of the structure, In that case, an exception will be thrown during serialization.

This class also supports the RNG implementation of userland. This is useful for tests that want to fix the expected calculation cost.

<code php>
class FixedNumberForTest extends Randomizer
{
    protected int $current = 0;

    protected function next(): int
    {
        return ++$this->current;
    }
}
</code>

===== Backward Incompatible Changes =====
The class name Randomizer is reserved and will not be available in userland.

===== Proposed PHP Version(s) =====
8.1

===== RFC Impact =====
==== To SAPIs ====
none

==== To Existing Extensions ====
none

==== To Opcache ====
none

==== New Constants ====
none

==== php.ini Defaults ====
none

===== Open Issues =====

=== Why not take an object oriented approach? ===
This is because it is overly complex and difficult to use, See my previous proposal and the discussion in the internals ML for more details.

  * https://wiki.php.net/rfc/object_scope_prng
  * https://externals.io/message/114378
  * https://externals.io/message/112819

=== Why XorShift128+ as the default algorithm? ===
This algorithm is capable of generating 64-bit random numbers, is used by major browsers, and is well validated. On the other hand, MT19937, currently used by PHP, can only generate 32-bit random numbers.

=== Why keep the MT19937 implementation?ã€€===
This is for compatibility. It facilitates quick and easy migration.

=== What algorithm does RANDOMIZER_SECURE use exactly? ===
It uses php_random_bytes() internally. This API is guaranteed to be a CSPRNG under any circumstances.

=== Why support CSPRNG? Isn't random_int() good enough? ===
The goal is to be able to migrate all RNG provided functions to this class in the future.
In other words, to be able to write code without using any of the following functions:

  * srand()
  * rand()
  * mt_srand()
  * mt_rand()
  * shuffle()
  * str_shuffle()
  * array_rand()
  * random_int()
  * random_bytes()

In order to use these functions properly, you need to understand PHP core. For many users, this can be difficult.

===== Vote =====
Voting opens 2021-MM-DD and 2021-YY-MM at 00:00:00 EDT. 2/3 required to accept.

<doodle title="Add RNG extension and deprecate and change some functions?" auth="zeriyoshi" voteType="single" closed="true"> 
   * Yes
   * No
</doodle>

===== Patches and Tests =====
TBD