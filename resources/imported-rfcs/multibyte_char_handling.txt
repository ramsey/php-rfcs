
====== PHP RFC: Multibyte Char Hnadling ======
  * Version: 0.1
  * Date: 2014-01-26
  * Author: Yasuo Ohgaki, yohgaki@ohgaki.net 
  * Status: Under Discussion
  * First Published at: http://wiki.php.net/rfc/multibyte_char_handling

===== Introduction =====

For example, addslashes()/stripslashes() has vulnerability that allows PHP script execution under certain environment via char encoding based attack. Counter measure using php_mblen() is proposed at first in security ML. However, php_mblen() is locale dependent and unreliable. Therefore, this is proposed and created RFC to decide.

Proper and secure char encoding handling is mandatory for application to work correctly. However, current PHP lacks default multibyte char handling feature. As a result, escapeshellarg()/escapeshellcmd()/fgetcsv() rely on locale based multibyte char handling for security and proper operation. addslahses()/ver_export()/stripslashes() lacks proper multibyte char handling. 

escapeshellarg()/escapeshellcmd()/fgetcsv() uses locale based multibyte char handling. i.e. php_mblem() Although this approach works mostly, it has several disadvantages.

  * Locale is not reliable and has issues on some locale, such as Turkish locale.
  * Locale is not visible for application programmers. Most developers just ignores locale.

New mbstring functions is added for users that are affected by this issue so that they can simply rename functions. Existing functions are changed to avoid confusions in the long run.


===== Proposal =====

PHP, including released versions, needs secure addslashes()/var_export()/stripslashes(). 

==== Add mb_addslashes()/mb_var_export()/mb_stripslashes() to released versions ====

For PHP 5.3 and up, add mb_addslashes()/mb_var_export()/mb_stripslashes() has encoding option.

  string mb_addslashes(string $str [, string $encoding=internal_encoding])
  string mb_var_export(mixed $var [, bool $return=FALSE [, string $encoding=internal_encoding]])
  string mb_stripslashes(string $str [, $encoding=internal_encoding])

==== addslashes()/var_export()/stripslashes() ====

For PHP 5.6 and up, add optional $encoding parameter to these functions and use mbstring for proper encoding handling. Make mbstring a module that compiled by default to handle various encodings. 

For PHP 5.6 and up, mb_addslashes()/mb_var_export()/mb_stripslashes() calls addslashes()/var_export()/stripslashes() internally.

escapeshellarg()/escapeshellcmd()/fgetcsv() rely on php_mblen(). These functions are modified to use mbstring and internal_encoding.

mbstring is rather large module. Therefore, it is better to be able to build PHP without mbstring. Any function uses mbstring feature use "#if", so that PHP could be built without mbstring.


===== Backward Incompatible Changes =====

None.

===== Proposed PHP Version(s) =====

  * PHP 5.3 and up - Additional mb_*() functions
  * PHP 5.6 and up - Multibyte aware addslashes()/etc

===== Impact to Existing Extensions =====

  * PHP 5.6 and up compiles mbstring by default. 

===== Open Issues =====

  * Please comment if there is.

Use of php_mblen() is alternative counter measure for addslashes issue.

===== Proposed Voting Choices =====

Yas/No

===== Patches and Tests =====

  * Prepared for review after vote.

===== Implementation =====

After the project is implemented, this section should contain 
  - the version(s) it was merged to
  - a link to the git commit(s)
  - a link to the PHP manual entry for the feature

===== References =====

Related RFC
  * https://wiki.php.net/rfc/default_encoding

CVE
  * CVE is assigned for addslashes issue. CVE-2014-1239

===== Rejected Features =====

Keep this updated with features that were discussed on the mail lists.