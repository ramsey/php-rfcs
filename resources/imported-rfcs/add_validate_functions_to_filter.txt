====== PHP RFC: Add validation functions to filter module ======
  * Version: 0.9
  * Date: 2016-08-03
  * Author: Yasuo Ohgaki <yohgaki@ohgaki.net>
  * Status: Under Discussion
  * First Published at: http://wiki.php.net/rfc/add_validate_functions_to_filter

===== Introduction =====

Input data validation is the most important security measure in software security. 

  * [[https://www.securecoding.cert.org/confluence/display/seccode/Top+10+Secure+Coding+Practices|CERT Top 10 Secure Coding Practices]]
  * [[https://www.owasp.org/index.php/OWASP_Secure_Coding_Practices_-_Quick_Reference_Guide|OWASP Secure Coding Practices -Quick Reference Guide]]

These recommends input validation by whitelist and reject invalid. 

We have filter module for this purpose, but it has problems
  * Functions are designed to "filter/convert value and accept" basically even with validation filter.
    * Allow undefined input(element in input array) by default.
    * They converts invalid values to NULL/FALSE and makes it difficult to identify validation error. This is especially a problem with array value validation.
    * Input validation must pass under normal condition. Validation error should result in exception error, but they are not.
  * String validation filter is missing even if string is the most dangerous input.
  * Multiple validation filters are not allowed. There are cases that we would like to use multiple filters, especially for strings.

===== Proposal =====

Followings are filter module improvement proposal.

====Add validation functions====

  * Add validate_var_array()/validate_input_array()/validate_var()/validate_input()

They are almost the same as filter_*() functions. Key differences compared to filter_*() functions are:

  * Raise UnexpectedValueException when they detect invalid input.
  * Conservative default. Empty element is not added by default. 

====Allow multiple filters to a input====

Example is easier to understand. New filter module allows multiple filters for both validation/sanitize filters.

<code php>
    <?php
    $args = array(
        'component'    =>
        array(
                // New filter module allows multiple filters and options as follows.
                // Array elements are evaluated in order. Non array spec is evaluated last.
                // Older implementation ignores this kind of spec silently.
                array(
                        'filter'    => FILTER_VALIDATE_INT,
                        'options'   => array('min_range' => 1, 'max_range' => 10)
                ),
                array(
                        'filter' => FILTER_VALIDATE_REGEXP,
                        'options' => array('regexp' => '/[0123456789]{2}/')
                ),
                array(
                        'filter' => FILTER_VALIDATE_FLOAT
                ),
        ),
    );
    
    // Throws UnexpectedValueException for invalid inputs.
    try {
        $myinputs = validate_var_array($data, $args);
        var_dump($myinputs); // NOTE: If you need returned array value, it MUST be inside try block.
    } catch (UnexpectedValueException $e) {
        var_dump($e->getMessage());
    }
</code>


====Add string validation filter====

Add missing string validation filter. This filter has conservative default. i.e. Strict validation by default. 

Features:
  * Validate string as UTF-8 by default. (Only UTF-8 is supported. Use FILTER_STRING_ENCODING_PASS encoding option to disable encoding check)
  * min_bytes/max_bytes options for string length. min_bytes default is 1, max_bytes default is 90.
  * Single line is allowed by default. Use FILTER_FLAG_STRING_MULTI_LINE flag to allow multi line (\r, \n) inputs.
  * Control char other than TAB(\t) is not allowed by default. Use FILTER_FLAG_STRING_ALLOW_CNTRL flag or 'allowed_chars' option to specify allowed chars whitelist.
  * FILTER_FLAG_STRING_ALPHA to allow only alphabet
  * FILTER_FLAG_STRING_NUM to allow only number(digit)
  * FILTER_FLAG_STRING_ALNUM to allow only alphanumeric 

Limitations:
  * UTF-8 only.
  * Chars control is limited code less than 127. (Only ASCII chars) 
  * Error message is not friendly.

===== Discussions =====

== Why it should be in core? ==

Input validation is the most important feature. PHP should provide easy to use/reliable/fast input validation feature. We should encourage strict input validation that rejects invalid(attacker) inputs by having stricter input validation features rather than filter(convert) and accept.

== Why not compare filter_var_array() result? ==
Following code may seem to work, but it would not.

<code php>
$ret = filter_var_array($arr, $validation_spec);
if ($ret != $arr) {
  die('Input does not validate');
}
</code>

  * One should never compare float equality. (Float string is converted to float type. Think of huge string value and result of float converted value comparison.)
  * They are filter(conversion) functions. e.g. URLs are converted to lowercase.
  * It allows empty input by default and add NULL element.

For these reasons, comparing original and return(filtered) value is not suitable for strict input validation.


===== Backward Incompatible Changes =====

None. filter_*() functions are not changed at all.

===== Proposed PHP Version(s) =====

7.1.0

===== RFC Impact =====
==== To SAPIs ====
None

==== To Existing Extensions ====
None

==== To Opcache ====
None

==== New Constants ====

  * FILTER_STRING_ENCODING_PASS - string validation filter encoding
  * FILTER_STRING_ENCODING_UTF8 - string validation filter encoding
  * FILTER_FLAG_STRING_RAW - string validation filter flag
  * FILTER_FLAG_STRING_ALLOW_CNTRL - string validation filter flag
  * FILTER_FLAG_STRING_MULTI_LINE - string validation filter flag
  * FILTER_FLAG_STRING_ALPHA - string validation filter flag
  * FILTER_FLAG_STRING_NUM - string validation filter flag
  * FILTER_FLAG_STRING_ALNUM - string validation filter flag

==== php.ini Defaults ====
No changes

===== Open Issues =====
Make sure there are no open issues when the vote starts!

===== Unaffected PHP Functionality =====
Existing filter features are not changed at all.

===== Future Scope =====

===== Proposed Voting Choices =====
This project requires a 2/3 majority



===== Patches and Tests =====

  * https://github.com/php/php-src/pull/2048


===== Implementation =====
After the project is implemented, this section should contain 
  - the version(s) it was merged to
  - a link to the git commit(s)
  - a link to the PHP manual entry for the feature

===== References =====
Links to external references, discussions or RFCs

===== Rejected Features =====
Keep this updated with features that were discussed on the mail lists.