====== Request for Comments: Continuous Integration via Jenkins ======
  * Version: 1.0
  * Date: 2011-10-20
  * Authors: Ferenc Kovacs <tyra3l.at.gmail.com>, Hannes Magnusson <bjori.at.php.net>
  * Status: Draft
  * First Published at: not yet

===== Introduction =====

The purpose of this RFC is to introduce the idea of using [[http://jenkins-ci.org/|Jenkins]] for Continuous Integration in the PHP project supported with a Proof of concept implementation.

===== Why do we need CI? =====

  * Runs the build and the tests automatically, doesn't require human interaction to spot build and test failures.
  * Provides a solid baseline for others to check that they are seeing a problem or it is just some configuration problem on their end.
  * Provides an easy way to check the build status and the test results for different platform/environments (different cpu architectures, OS, etc.).
  * Allows us to follow the build trends and history.

===== gcov.php.net =====
  * gcov.php.net is an in-house php application written in php: http://svn.php.net/viewvc/web/php-gcov/trunk/
  * gcov.php.net does a throughout analysis (building the supported php versions and executing the testsuite with [[http://gcc.gnu.org/onlinedocs/gcc/Gcov.html|gcov]], [[http://ltp.sourceforge.net/coverage/lcov.php|lcov]] and [[http://valgrind.org/|Valgrind]] for test coverage and memory leaks, and does some [[https://wiki.php.net/ideas/automaticcodechecker|code checking]].
  * gcov.php.net does a throughout analysis, but having to wait more than 2 days for a build result isn't really useful for checking build or test failures early.
  * the development of gcov.php.net and the related work seems halted in the absence of Nuno Lopes.

===== Why Jenkins? =====
  * It is community based and open source.
  * It is java based, so it is easy to install on most platforms.
  * It has a nice market share, good documentation and a pluggable architechture which allows it to be really [[https://wiki.jenkins-ci.org/display/JENKINS/Plugins|extendable]].
  * Provides a web interface for the configuration, the most challanging configuration step could be writing your ant build.xml (so it is easy). 
  * Supports both SVN, git and mercurial (and almost every other SCM), so the DVCS migration shouldn't be a problem.
  * Supports distributed builds out of the box.
  * Sebastian Bergmann prefers it over everything else. :)

===== ci.qa.php.net =====

We have a demo/Proof of concept interface at http://ci.qa.php.net/
  * It consist 2 vm: a 64 and 32 bit debian squeeze
  * It has 6 [[https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds|matrix job]]:
    * two for each branch(5.3, 5.4, trunk):
      * one for ./configure && make
      * one for running the testsuite against that branch
  * I also patched the run-tests.php to be able to generate ant junit compatible xml report which is supported by jenkins.
  * Each matrix job will be executed on both node, and the results will be aggregated:
    * if the job fails of any of the nodes, the job will be failed
    * for the testsuite jobs, the test results will be aggregated:
      * see http://ci.qa.php.net/job/php-src-5.3-matrix-tests/3/testReport/? fox example
  * I'm planning a documentation about the current setup (which plugins, packages was used, configuration, general jenkins terminologies, introducting the terms like job, downstream job, matrix job, configuration job, distributed jobs, etc.).
  * Some config files and my run-tests.php patches are available at https://github.com/Tyrael/ci.qa.php.net

===== Current problems =====
  * Not sure what to do with XFAILs, JUnit doesn't provide anything similar in concept(http://zoomsplatter.blogspot.com/2008/06/why-xfail.html), so for now failing XFAIL is a passing test, passing XFAIL is a test failure, but we can swap that if needed. 
  * A few tests fail on jenkins which could pass elsewhere cause we don't have enough ram, so some tests timeout, when the machine starts swapping(Zend/tests/bug55509.phpt for example allocates 2.1G memory).

===== Other alternatives =====
  * [[http://svn.php.net/viewvc/web/php-rmtools/trunk/|rmtools]]: Pierre and Dan is [[http://www.mail-archive.com/internals@lists.php.net/msg53358.html|working on]] a distributed build environment.
  * buildbot was [[https://wiki.php.net/internals/buildbot|planned]] to be set up, but it went [[http://www.mail-archive.com/internals@lists.php.net/msg43792.html|MIA]].
  * For the record: the PEAR group [[https://wiki.php.net/pear/qa/ci|is using/used]] PHPUnderControl which is a patchset on top of CruiseControl(another java based CI tool), which could also be used for building php-src, but it doesn't really have anything over Jenkins and the development seems halted: the last version is more than a year old. 
  * other CI tools (there is a whole bunch)

===== Future plans =====
  * Enable every extension and feature for the builds(--enable-* and --with-* for configure)
  * The installation of other slaves are also in progress (FreeBSD, NetBSD, OpenBSD, others could be added as needed).
  * Adding other machines could be necessary (the current and the above mentioned in-progress nodes are only virtual machines on the same sole physical server).
  * Implement custom authentication through master.php.net.
  * The phpdoc building could also be added to jenkins.
  * The pecl extensions could be also built in Jenkins regulary.
  * Jenkins could be also used for our php based projects (web/*, phpunit tests, etc.)
  * It is also possible to replace the current functionality of gcov.php.net with jenkins if needed.

===== Changelog =====

1.0 2011-10-20 Initial version

